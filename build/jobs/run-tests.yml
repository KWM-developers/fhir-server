parameters:
- name: version
  type: string
- name: keyVaultNAme
  type: string
- name: runIntegration
  type: boolean
  default: true
- name: runE2E
  type: boolean
  default: true

jobs:
- job: "integrationTests"
  condition: eq('${{ parameters.runIntegration }}', true)
  pool:
    vmImage: 'vs2017-win2016'
  steps:
  - task: DownloadBuildArtifacts@0
    inputs:
      buildType: 'current'
      downloadType: 'single'
      downloadPath: '$(System.ArtifactsDirectory)'
      artifactName: 'IntegrationTests'

  - task: UseDotNet@2
    inputs:
      version: '3.1.100' 

  - task: AzureKeyVault@1
    displayName: 'Azure Key Vault: ${{ parameters.keyVaultNAme }}'
    inputs:
      azureSubscription: 'Microsoft Health Open Source Subscription'
      KeyVaultName: '${{ parameters.keyVaultNAme }}'

  - task: AzureKeyVault@1
    displayName: 'Azure Key Vault: ${{ parameters.keyVaultNAme }}-sql'
    inputs:
      azureSubscription: 'Microsoft Health Open Source Subscription'
      KeyVaultName: '${{ parameters.keyVaultNAme }}-sql'

  - task: VSTest@2
    displayName: 'Run Integration Tests'
    inputs:
      testSelector: testAssemblies
      testAssemblyVer2: |
        **\*${{ parameters.version }}.Tests.Integration*.dll
      searchFolder: '$(System.ArtifactsDirectory)'
    env:
      'CosmosDb:Host': $(CosmosDb--Host)
      'CosmosDb:Key': $(CosmosDb--Key)
      'SqlServer:ConnectionString': $(SqlServer--ConnectionString)

- job: 'e2eTests'
  condition: eq('${{ parameters.runE2E }}', true)
  dependsOn: []
  pool:
    vmImage: 'vs2017-win2016'
  steps:
  - task: DownloadBuildArtifacts@0
    inputs:
      buildType: 'current'
      downloadType: 'single'
      downloadPath: '$(System.ArtifactsDirectory)'
      artifactName: 'IntegrationTests'

  - task: UseDotNet@2
    inputs:
      version: '3.1.100' 
        
  - task: AzureKeyVault@1
    displayName: 'Azure Key Vault: resolute-oss-tenant-info'
    inputs:
      azureSubscription: 'Microsoft Health Open Source Subscription'
      KeyVaultName: 'resolute-oss-tenant-info'
    
  - task: AzurePowerShell@4
    displayName: 'Set Variables'
    inputs:
      azureSubscription: 'Microsoft Health Open Source Subscription'
      azurePowerShellVersion: latestVersion
      ScriptType: inlineScript
      Inline: |
        Install-Module -Name AzureAD -Force -Verbose -Scope CurrentUser
        $tenantId = "$(tenant-id)"

        # Get admin token
        $username = "$(tenant-admin-user-name)"
        $password_raw = "$(tenant-admin-user-password)"
        $password =  ConvertTo-SecureString -AsPlainText $password_raw -Force
        $adminCredential = New-Object PSCredential $username,$password
 
        $adTokenUrl = "https://login.microsoftonline.com/$tenantId/oauth2/token"
        $resource = "https://graph.windows.net/"
 
        $body = @{
            grant_type = "password"
            username   = $username
            password   = $password_raw
            resource   = $resource 
            client_id  = "1950a258-227b-4e31-a9cf-717495945fc2" # Microsoft Azure PowerShell
        }
 
        $response = Invoke-RestMethod -Method 'Post' -Uri $adTokenUrl -ContentType "application/x-www-form-urlencoded" -Body $body
        Connect-AzureAD -TenantId $tenantId -AadAccessToken $response.access_token -AccountId $username

        Import-Module $(System.DefaultWorkingDirectory)/samples/scripts/PowerShell/FhirServer/FhirServer.psd1
        Import-Module $(System.DefaultWorkingDirectory)/release/scripts/PowerShell/FhirServerRelease/FhirServerRelease.psd1

        $output = Add-AadTestAuthEnvironment -TestAuthEnvironmentPath $(System.DefaultWorkingDirectory)/testauthenvironment.json -EnvironmentName $(DeploymentEnvironmentName) -TenantAdminCredential $adminCredential
        # --------------------------------------------------
        $secrets = Get-AzKeyVaultSecret -VaultName $(DeploymentEnvironmentName)-ts

        foreach($secret in $secrets)
        {
            $environmentVariableName = $secret.Name.Replace("--","_")
            $secretValue = Get-AzKeyVaultSecret -VaultName $(DeploymentEnvironmentName)-ts -Name $secret.Name
            Write-Host "##vso[task.setvariable variable=$($environmentVariableName)]$($secretValue.SecretValueText)"
        }

        Write-Host "##vso[task.setvariable variable=Resource]$(TestEnvironmentUrl)"

        dotnet dev-certs https

  - task: VSTest@2
    displayName: 'Run E2E Tests'
    inputs:
      testSelector: testAssemblies
      testAssemblyVer2: |
        **\*${{ parameters.version }}.Tests.E2E*.dll
      searchFolder: '$(System.ArtifactsDirectory)'
